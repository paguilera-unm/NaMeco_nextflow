// ============================================================
//  NaMeco — nextflow.config  (Nextflow >= 24.10)
//
//  Publishing gestionado desde el output {} block en main.nf
//  publishDir en procesos está deprecado desde Nextflow 24.x
// ============================================================

// ── Default parameters ──────────────────────────────────────
params {

    // I/O
    inp_dir         = null
    out_dir         = "NaMeco_out"      // usado como outputDir base

    // Quality control
    qc              = true
    phred           = 10
    min_length      = 1200
    max_length      = 2000
    primer_F        = "AGAGTTTGATCMTGGCTCAG"
    primer_R        = "CGGTTACCTTGTTACGACTT"
    primer_PI       = 0.6

    // Clustering
    kmer            = 5
    cluster_size    = 10
    subsample       = 200
    select_epsilon  = 0.1
    random_state    = 888

    // Read correction
    n_polish        = 3

    // Taxonomy
    db_type         = "All"           // "All" o "SpeciesReps"
    db_version      = "226.0"
    gap             = 1.0
    min_fraction    = 0.6
    mask_taxa       = true
    db_path         = null            // null = auto (out_dir/GTDB-<version>/<db_type>)

    // Resources
    threads         = 2
}

// ── Directorio base de publicación (reemplaza params.out_dir en publishDir) ──
outputDir = params.out_dir

// ── Opciones globales de publicación (aplicadas a todos los targets) ─────────
workflow.output {
    mode        = 'copy'    // 'copy' | 'symlink' | 'move' | 'rellink'
    overwrite   = true      // sobreescribir si el archivo ya existe
}

// ── Process defaults ─────────────────────────────────────────
process {
    cpus   = params.threads
    memory = '8 GB'
    time   = '24 h'

    withLabel: 'low_cpu' {
        cpus   = 1
        memory = '4 GB'
    }
    withLabel: 'high_cpu' {
        cpus   = { params.threads }
        memory = '16 GB'
    }
    withLabel: 'high_mem' {
        cpus   = { params.threads }
        memory = '32 GB'
        time   = '48 h'
    }
}

// ── Perfiles ─────────────────────────────────────────────────
profiles {

    standard {
        process.executor = 'local'
    }

    conda {
        conda.enabled    = true
        process.conda    = "${projectDir}/environment.yml"
    }

    docker {
        docker.enabled   = true
        process.container = 'nameco:latest'
    }

    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        process.container      = 'docker://nameco:latest'
    }

    slurm {
        process.executor       = 'slurm'
        process.queue          = 'normal'
        process.clusterOptions = '--account=myproject'
    }

    // Perfil de test rápido
    test {
        params.inp_dir       = "${projectDir}/test_data"
        params.out_dir       = "test_out"
        outputDir            = "test_out"
        params.threads       = 2
        params.min_length    = 1000
        params.max_length    = 2000
        params.cluster_size  = 5
        params.subsample     = 50
        params.n_polish      = 1
        params.db_type       = "SpeciesReps"
        params.db_version    = "220.0"
    }
}

// ── Reportes y trazabilidad ──────────────────────────────────
def trace_ts = new java.util.Date().format('yyyy-MM-dd_HH-mm-ss')

timeline {
    enabled = true
    file    = "${params.out_dir}/pipeline_info/timeline_${trace_ts}.html"
}
report {
    enabled = true
    file    = "${params.out_dir}/pipeline_info/report_${trace_ts}.html"
}
trace {
    enabled = true
    file    = "${params.out_dir}/pipeline_info/trace_${trace_ts}.txt"
}
dag {
    enabled = true
    file    = "${params.out_dir}/pipeline_info/dag_${trace_ts}.svg"
}
